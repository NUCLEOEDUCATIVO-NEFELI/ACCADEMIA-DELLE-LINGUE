<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Accademia delle Lingue</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
        }
        
        /* Login Admin */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3a5f 0%, #152a45 100%);
            padding: 1rem;
        }
        
        .login-box {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .login-box h1 {
            text-align: center;
            color: #1e3a5f;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
        }
        
        .topbar {
            background: linear-gradient(135deg, #1e3a5f 0%, #152a45 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .topbar h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 640px) {
            .stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1e3a5f;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #1e3a5f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        @media (min-width: 640px) {
            .card-body {
                padding: 1.5rem;
            }
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            -webkit-appearance: none;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1e3a5f;
        }
        
        textarea.form-input {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1e3a5f 0%, #152a45 100%);
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #1e3a5f;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            color: #64748b;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Password display */
        .password-box {
            background: #f0fdf4;
            border: 2px dashed #10b981;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin: 1rem 0;
        }
        
        .password-display {
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            font-weight: bold;
            color: #059669;
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            word-break: break-all;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-header h2 {
            color: #1e3a5f;
            font-size: 1.25rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        /* Empty state */
        .empty {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .tab-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            white-space: nowrap;
        }
        
        .tab-btn.active {
            border-color: #1e3a5f;
            color: #1e3a5f;
            background: #eff6ff;
        }
        
        /* Grid */
        .grid-2 {
            display: grid;
            gap: 1rem;
        }
        
        @media (min-width: 640px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Hide on mobile */
        @media (max-width: 640px) {
            .hide-mobile {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>‚öôÔ∏è Admin Accesso</h1>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label class="form-label">Password Admin</label>
                    <input type="password" id="adminPassword" class="form-input" placeholder="Inserisci password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Accedi</button>
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="login.html" style="color: #64748b; text-decoration: none; font-size: 0.875rem;">‚Üê Torna al Login Studenti</a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- DASHBOARD -->
    <div id="dashboard" class="dashboard">
        <div class="topbar">
            <h1>üìã Gestione Accademia</h1>
            <button class="btn-logout" onclick="adminLogout()">Logout</button>
        </div>
        
        <div class="container">
            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="statPending">0</div>
                    <div class="stat-label">In Attesa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statApproved">0</div>
                    <div class="stat-label">Approvati</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statUsers">0</div>
                    <div class="stat-label">Utenti</div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('pending')" id="tab-pending">‚è≥ In Attesa</button>
                <button class="tab-btn" onclick="showTab('approved')" id="tab-approved">‚úÖ Approvati</button>
                <button class="tab-btn" onclick="showTab('rejected')" id="tab-rejected">‚ùå Rifiutati</button>
                <button class="tab-btn" onclick="showTab('users')" id="tab-users">üë• Utenti</button>
            </div>
            
            <!-- Richieste in Attesa -->
            <div id="view-pending" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <span>Richieste da Approvare</span>
                    </div>
                    <div class="card-body" id="pendingList">
                        <div class="empty">
                            <div class="empty-icon">üì≠</div>
                            <p>Nessuna richiesta in attesa</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Approvati -->
            <div id="view-approved" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <span>Richieste Approvate</span>
                    </div>
                    <div class="card-body" id="approvedList">
                        <div class="empty">
                            <div class="empty-icon">‚úÖ</div>
                            <p>Nessuna richiesta approvata</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rifiutati -->
            <div id="view-rejected" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <span>Richieste Rifiutate</span>
                    </div>
                    <div class="card-body" id="rejectedList">
                        <div class="empty">
                            <div class="empty-icon">‚ùå</div>
                            <p>Nessuna richiesta rifiutata</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Utenti -->
            <div id="view-users" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <span>Utenti Registrati</span>
                        <button class="btn btn-primary" onclick="showAddUserModal()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">‚ûï Aggiungi</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Corso</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL APPROVA -->
    <div id="approveModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>‚úÖ Approva Richiesta</h2>
            </div>
            <div class="modal-body">
                <div id="approveAlert"></div>
                
                <div class="form-group">
                    <label class="form-label">Studente</label>
                    <input type="text" id="appNome" class="form-input" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="appEmail" class="form-input" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Corso</label>
                    <input type="text" id="appCorso" class="form-input" readonly>
                </div>
                
                <div class="password-box">
                    <div style="font-size: 0.875rem; color: #065f46; font-weight: 600;">Password Generata</div>
                    <div class="password-display" id="appPassword">...</div>
                    <button type="button" class="btn btn-secondary" onclick="regeneratePassword()" style="margin-top: 0.5rem; font-size: 0.8rem;">üîÑ Rigenera</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Messaggio per lo studente (opzionale)</label>
                    <textarea id="appMessaggio" class="form-input" placeholder="Aggiungi un messaggio personalizzato..."></textarea>
                </div>
                
                <!-- Form nascosto per FormSubmit -->
                <form id="emailForm" action="https://formsubmit.co/infonefelieducation@gmail.com" method="POST" style="display: none;">
                    <input type="hidden" name="_subject" value="üèõÔ∏è Accademia delle Lingue - Credenziali di Accesso">
                    <input type="hidden" name="_template" value="table">
                    <input type="hidden" name="_captcha" value="false">
                    <input type="hidden" name="_next" id="formNextUrl">
                    <input type="hidden" name="email" id="formEmail">
                    <input type="hidden" name="Studente" id="formStudente">
                    <input type="hidden" name="Email" id="formEmail2">
                    <input type="hidden" name="Password" id="formPassword">
                    <input type="hidden" name="Corso" id="formCorso">
                    <input type="hidden" name="Messaggio" id="formMessaggio">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                <button class="btn btn-success" onclick="confirmApprove()" id="btnConfirm">üìß Invia Email e Approva</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL AGGIUNGI UTENTE -->
    <div id="addUserModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>‚ûï Aggiungi Utente</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome completo *</label>
                    <input type="text" id="addNome" class="form-input" placeholder="Mario Rossi">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="addEmail" class="form-input" placeholder="mario@email.it">
                </div>
                <div class="form-group">
                    <label class="form-label">Corso *</label>
                    <select id="addCorso" class="form-select">
                        <option value="">Seleziona...</option>
                        <option value="Inglese A1">Inglese A1</option>
                        <option value="Inglese A2">Inglese A2</option>
                        <option value="Inglese B1">Inglese B1</option>
                        <option value="Inglese B2">Inglese B2</option>
                        <option value="Italiano L2">Italiano L2</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddModal()">Annulla</button>
                <button class="btn btn-success" onclick="confirmAddUser()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const ADMIN_PASSWORD = 'admin2024'; // Cambia questa password!
        const EMAIL_DESTINATION = 'infonefelieducation@gmail.com'; // Email per FormSubmit
        
        // STATE
        let currentRequest = null;
        let generatedPassword = '';
        
        // INIT
        document.addEventListener('DOMContentLoaded', function() {
            // Check if logged in
            if (sessionStorage.getItem('adminLogged') === 'true') {
                showDashboard();
            }
            
            // Login form
            document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const pwd = document.getElementById('adminPassword').value;
                if (pwd === ADMIN_PASSWORD) {
                    sessionStorage.setItem('adminLogged', 'true');
                    showDashboard();
                } else {
                    alert('‚ùå Password errata!');
                }
            });
        });
        
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateStats();
            loadPending();
            loadApproved();
            loadRejected();
            loadUsers();
        }
        
        function adminLogout() {
            sessionStorage.removeItem('adminLogged');
            window.location.reload();
        }
        
        // STATS
        function updateStats() {
            const requests = JSON.parse(localStorage.getItem('accademia_requests') || '[]');
            const users = JSON.parse(localStorage.getItem('accademia_users') || '[]');
            
            document.getElementById('statPending').textContent = requests.filter(r => r.status === 'pending').length;
            document.getElementById('statApproved').textContent = requests.filter(r => r.status === 'approved').length;
            document.getElementById('statTotal').textContent = requests.length;
            document.getElementById('statUsers').textContent = users.length;
        }
        
        // TABS
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('view-' + tab).classList.remove('hidden');
            
            if (tab === 'pending') loadPending();
            if (tab === 'approved') loadApproved();
            if (tab === 'rejected') loadRejected();
            if (tab === 'users') loadUsers();
        }
        
        // LOAD PENDING
        function loadPending() {
            const requests = JSON.parse(localStorage.getItem('accademia_requests') || '[]');
            const pending = requests.filter(r => r.status === 'pending').sort((a,b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('pendingList');
            
            if (pending.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">üì≠</div>
                        <p>Nessuna richiesta in attesa</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="grid-2">';
            pending.forEach(req => {
                html += `
                    <div class="card">
                        <div class="card-body">
                            <h3 style="color: #1e3a5f; margin-bottom: 0.5rem;">${req.nome}</h3>
                            <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">üìß ${req.email}</p>
                            <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">üìö ${req.corso}</p>
                            <p style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 1rem;">${new Date(req.date).toLocaleString('it-IT')}</p>
                            ${req.messaggio ? `<p style="font-size: 0.875rem; color: #64748b; margin-bottom: 1rem; font-style: italic;">"${req.messaggio}"</p>` : ''}
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-success" onclick="openApproveModal('${req.id}')" style="flex: 1; padding: 0.5rem;">‚úÖ Approva</button>
                                <button class="btn btn-danger" onclick="rejectRequest('${req.id}')" style="flex: 1; padding: 0.5rem;">‚ùå Rifiuta</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // LOAD APPROVED
        function loadApproved() {
            const requests = JSON.parse(localStorage.getItem('accademia_requests') || '[]');
            const approved = requests.filter(r => r.status === 'approved').sort((a,b) => new Date(b.approvedDate) - new Date(a.approvedDate));
            
            const container = document.getElementById('approvedList');
            
            if (approved.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">‚úÖ</div>
                        <p>Nessuna richiesta approvata</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table><thead><tr><th>Data</th><th>Nome</th><th>Email</th><th>Corso</th><th class="hide-mobile">Password</th></tr></thead><tbody>';
            approved.forEach(req => {
                html += `
                    <tr>
                        <td>${new Date(req.approvedDate).toLocaleDateString('it-IT')}</td>
                        <td>${req.nome}</td>
                        <td>${req.email}</td>
                        <td>${req.corso}</td>
                        <td class="hide-mobile"><code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: monospace;">${req.password || 'N/A'}</code></td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // LOAD REJECTED
        function loadRejected() {
            const requests = JSON.parse(localStorage.getItem('accademia_requests') || '[]');
            const rejected = requests.filter(r => r.status === 'rejected').sort((a,b) => new Date(b.rejectedDate) - new Date(a.rejectedDate));
            
            const container = document.getElementById('rejectedList');
            
            if (rejected.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">‚ùå</div>
                        <p>Nessuna richiesta rifiutata</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table><thead><tr><th>Data</th><th>Nome</th><th>Email</th><th>Corso</th></tr></thead><tbody>';
            rejected.forEach(req => {
                html += `
                    <tr>
                        <td>${new Date(req.rejectedDate).toLocaleDateString('it-IT')}</td>
                        <td>${req.nome}</td>
                        <td>${req.email}</td>
                        <td>${req.corso}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        // LOAD USERS
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('accademia_users') || '[]');
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nessun utente registrato</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.nome}</td>
                    <td>${u.email}</td>
                    <td>${u.corso || '-'}</td>
                    <td><span class="badge ${u.firstLoginDone ? 'badge-approved' : 'badge-pending'}">${u.firstLoginDone ? 'Attivo' : 'Primo accesso'}</span></td>
                    <td><button class="btn btn-danger" onclick="deleteUser('${u.email}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }
        
        // APPROVE MODAL
        function openApproveModal(id) {
            const requests = JSON.parse(localStorage.getItem('accademia_requests') || '[]');
            const req = requests.find(r => r.id === id);
            
            if (!req) return;
            
            currentRequest = req;
            
            document.getElementById('appNome').value = req.nome;
            document.getElementById('appEmail').value = req.email;
            document.getElementById('appCorso').value = req.corso;
            
            regeneratePassword();
            
            document.getElementById('approveModal').classList.add('active');
        }
        
        function regeneratePassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let pwd = '';
            pwd += 'A'; // maiuscola
            pwd += 'a'; // minuscola
            pwd += '1'; // numero
            pwd += '!'; // simbolo
            
            for (let i = 4; i < 12; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // mischia
            generatedPassword = pwd.split('').sort(() => 0.5 - Math.random()).join('');
            document.getElementById('appPassword').textContent = generatedPassword;
        }
        
        function closeModal() {
            document.getElementById('approveModal').classList.remove('active');
            currentRequest = null;
        }
        
        function confirmApprove() {
            if (!currentRequest) return;
            
            const btn = document.getElementById('btnConfirm');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Invio...';
            
            // Prepara email
            const messaggio = document.getElementById('appMessaggio').value;
            const loginUrl = window.location.origin + '/login.html';
            
            const emailBody = `
üèõÔ∏è ACCADEMIA DELLE LINGUE - CREDENZIALI DI ACCESSO

Ciao ${currentRequest.nome},

La tua richiesta √® stata APPROVATA!

üîê CREDENZIALI:
Email: ${currentRequest.email}
Password: ${generatedPassword}

üìö Corso: ${currentRequest.corso}

üîó ACCEDI: ${loginUrl}

‚ö†Ô∏è Al primo accesso dovrai cambiare la password!

${messaggio ? '\nüìù Messaggio dall\'amministratore:\n' + messaggio : ''}

---
Accademia delle Lingue
            `;
            
            // Compila form nascosto
            document.getElementById('formEmail').value = currentRequest.email;
            document.getElementById('formStudente').value = currentRequest.nome;
            document.getElementById('formEmail2').value = currentRequest.email;
            document.getElementById('formPassword').value = generatedPassword;
            document.getElementById('formCorso').value = currentRequest.corso;
            document.getElementById('formMessaggio').value = emailBody;
            
            // Salva utente
            const users = JSON.parse(localStorage.getItem('accademia_users') || '[]');
            users.push({
                email: currentRequest.email,
                password: generatedPassword,
                nome: currentRequest.nome,
                corso: currentRequest.corso,
                active: true,
                firstLoginDone: false,
                created: new Date().toISOString()
            });
            localStorage.setItem('accademia_users', JSON.stringify(users));
            
            // Aggiorna richiesta
            const requests = JSON.parse(localStorage.getItem('accademia_requests') || '[]');
            const idx = requests.findIndex(r => r.id === currentRequest.id);
            if (idx !== -1) {
                requests[idx].status = 'approved';
                requests[idx].approvedDate = new Date().toISOString();
                requests[idx].password = generatedPassword;
                localStorage.setItem('accademia_requests', JSON.stringify(requests));
            }
            
            // Invia email (FormSubmit)
            document.getElementById('emailForm').submit();
        }
        
        // REJECT
        function rejectRequest(id) {
            if (!confirm('Sei sicuro di voler RIFIUTARE questa richiesta?')) return;
            
            const requests = JSON.parse(localStorage.getItem('accademia_requests') || '[]');
            const idx = requests.findIndex(r => r.id === id);
            
            if (idx !== -1) {
                requests[idx].status = 'rejected';
                requests[idx].rejectedDate = new Date().toISOString();
                localStorage.setItem('accademia_requests', JSON.stringify(requests));
                updateStats();
                loadPending();
            }
        }
        
        // ADD USER MODAL
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }
        
        function closeAddModal() {
            document.getElementById('addUserModal').classList.remove('active');
            document.getElementById('addNome').value = '';
            document.getElementById('addEmail').value = '';
            document.getElementById('addCorso').value = '';
        }
        
        function confirmAddUser() {
            const nome = document.getElementById('addNome').value.trim();
            const email = document.getElementById('addEmail').value.trim().toLowerCase();
            const corso = document.getElementById('addCorso').value;
            
            if (!nome || !email || !corso) {
                alert('Compila tutti i campi!');
                return;
            }
            
            // Genera password
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let pwd = '';
            for (let i = 0; i < 12; i++) {
                pwd += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Salva utente
            const users = JSON.parse(localStorage.getItem('accademia_users') || '[]');
            
            if (users.find(u => u.email === email)) {
                alert('Questa email esiste gi√†!');
                return;
            }
            
            users.push({
                email: email,
                password: pwd,
                nome: nome,
                corso: corso,
                active: true,
                firstLoginDone: false,
                created: new Date().toISOString()
            });
            
            localStorage.setItem('accademia_users', JSON.stringify(users));
            
            alert(`‚úÖ Utente creato!\n\nEmail: ${email}\nPassword: ${pwd}\n\nComunica queste credenziali allo studente.`);
            
            closeAddModal();
            updateStats();
            loadUsers();
        }
        
        // DELETE USER
        function deleteUser(email) {
            if (!confirm('Eliminare questo utente?')) return;
            
            let users = JSON.parse(localStorage.getItem('accademia_users') || '[]');
            users = users.filter(u => u.email !== email);
            localStorage.setItem('accademia_users', JSON.stringify(users));
            
            updateStats();
            loadUsers();
        }
        
        // Auto refresh ogni 10 secondi per nuove richieste
        setInterval(() => {
            if (document.getElementById('dashboard').style.display === 'block') {
                updateStats();
                // Ricarica solo se siamo nella tab pending
                if (!document.getElementById('view-pending').classList.contains('hidden')) {
                    loadPending();
                }
            }
        }, 10000);
    </script>
</body>
</html>
